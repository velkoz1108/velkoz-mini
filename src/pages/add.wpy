<style lang="less">
.container {
  width: 100%;
  background-color: #f5f6f9;
}
.custom {
  color: yellow;
}
</style>
<wxs module="m1" lang="babel">

</wxs>
<template>
  <div class="container">
    <van-form @submit="onSubmit" style="width:100%;height:100px">
      <!-- çºªå¿µæ—¥åç§° -->
      <van-field
        :value="name"
        name="çºªå¿µæ—¥åç§°"
        label="çºªå¿µæ—¥åç§°"
        placeholder="è¯·è¾“å…¥çºªå¿µæ—¥åç§°"
        @blur="myBlur($event, 'name')"
      />

      <!-- é€‰æ‹©ç±»å‹ -->

      <!-- <van-field
        readonly
        clickable
        name="picker"
        :value="reminderType"
        label="çºªå¿µæ—¥ç±»å‹"
        placeholder="ç‚¹å‡»é€‰æ‹©ç±»å‹"
        @click="showPicker = true"
      />
      <van-popup wx:if="{{showPicker}}" show="{{ showPicker }}" position="bottom">
        <van-picker
          show-toolbar
          :columns="columns"
          @confirm="onConfirmType"
          @cancel="showPicker = false"
        />
      </van-popup> -->

      <!-- æ—¥æœŸé€‰æ‹© -->

      <van-field
        readonly
        clickable
        name="calendar"
        :value="date"
        label="æ—¥å†"
        placeholder="ç‚¹å‡»é€‰æ‹©æ—¥æœŸ"
        @click="showCalendar = true"
      />

      <van-calendar
        show="{{ showCalendar }}"
        :style="{ height: '50%' }"
        :minDate="minDate" 
        :maxDate="maxDate" 
        color="#1989fa"
        @close="onClose"
        @confirm="onConfirm"
      />

      <!-- å›¾æ ‡ -->
      <van-field
        readonly
        clickable
        name="icon-picker"
        :value="iconName"
        label="å›¾æ ‡"
        placeholder="ç‚¹å‡»é€‰æ‹©å›¾æ ‡"
        @click="showIconPicker = true"
      />
      <van-popup wx:if="{{showIconPicker}}" show="{{ showIconPicker }}" position="bottom">
        <van-picker
          show-toolbar
          allow-html="true"
          title="é€‰æ‹©å›¾æ ‡"
          :columns="iconList"
          @confirm="onConfirmIcon"
          @cancel="showIconPicker = false"
        />
      </van-popup>



      <div style="margin: 16px;">
        <van-button round block type="info" native-type="submit" @click="save">æäº¤</van-button>
      </div>
    </van-form>

     <van-toast id="van-toast" style="width:100%;height:10rem;" />
  </div>
</template>

<script>
import wepy from '@wepy/core';
import eventHub from '../common/eventHub';
import { mapState } from '@wepy/x';
import store from '../store';
import testMixin from '../mixins/test';
import Toast from '@vant/weapp/lib/toast/toast';

wepy.page({
  store,
  config: {
    navigationBarTitleText: 'test'
  },

  mixins: [testMixin],

  data: {
    showCalendar: false,
    showPicker: false,
    minDate: new Date(2021, 0, 1),
    maxDate: new Date(2023, 0, 31),
    name: '',
    radio: '1',
    date: '',
    days: '0å¤©',
    of: '',
    reminderType: 'çºªå¿µæ—¥',
    reminderTypeId: 0,
    columns: ['çºªå¿µæ—¥', 'å€’æ•°æ—¥'],
    showIconPicker: false,
    iconName: 'ğŸ”¥',
    iconKey: 'fire',
    iconList: [
      { text: 'â¤', key: 'like' },
      { text: 'ğŸ”¥', key: 'fire' },
      { text: 'â­ï¸', key: 'star' },
      { text: 'ğŸ’', key: 'gem' },
      { text: 'ğŸ”', key: 'lock' }
    ],
    db: {}
  },

  computed: {
    maxDate() {
      const now = new Date();
      return new Date(
        now.getFullYear(),
        now.getMonth() + 6,
        now.getDate()
      ).getTime();
    },
    minDate() {
      const now = new Date();
      return new Date(
        now.getFullYear(),
        now.getMonth() - 6,
        now.getDate()
      ).getTime();
    }
  },

  methods: {
    formatDate(date) {
      return `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}`;
    },
    onConfirm(date) {
      console.log(date.$wx.detail);
      this.date = this.formatDate(date.$wx.detail);
      this.showCalendar = false;
    },
    onClose(e) {
      console.log('close calendar ... ', e);
      this.showCalendar = false;
    },
    onSubmit() {
      console.log('form submit ...');
    },
    myBlur(e, name) {
      if (name === 'name') {
        this.name = e.$wx.detail.value;
      }
    },
    onConfirmType(value) {
      console.log(value);
      this.reminderType = value.$wx.detail.value;
      this.reminderTypeId = value.$wx.detail.index;
      this.showPicker = false;
    },
    onConfirmIcon(value) {
      console.log('icon --> ', value);
      this.iconName = value.$wx.detail.value.text;
      this.iconKey = value.$wx.detail.value.key;
      this.showIconPicker = false;
    },
    save() {
      console.log('save data ...');
      if (this.name == '') {
        console.log('name is empty');
        Toast.fail('å¿…å¡«é¡¹ä¸èƒ½ä¸ºç©º');
        return;
      }
      if (this.iconKey == '') {
        this.iconKey = 'like';
      }
      // è®¡ç®—æ—¥æœŸå·®å‡ å¤©
      const now = new Date();
      const tagetDate = new Date(this.date);
      let diff = tagetDate - now;
      const diffDays = parseInt(Math.abs(diff) / (1 * 24 * 60 * 60 * 1000));
      if (diffDays < 0) {
        //çºªå¿µæ—¥
        console.log('è¿™æ˜¯çºªå¿µæ—¥', diffDays);
        this.reminderType = 'çºªå¿µæ—¥';
        this.reminderTypeId = 0;
        this.days = diffDays + 'å¤©';
        this.of = 'å·²ç»';
      } else {
        //å€’æ•°æ—¥
        console.log('è¿™æ˜¯å€’æ•°æ—¥', diffDays);
        this.reminderType = 'å€’æ•°æ—¥';
        this.reminderTypeId = 1;
        this.days = diffDays + 1 + 'å¤©';
        this.of = 'è¿˜æœ‰';
      }

      this.db.collection('reminder').add({
        data: {
          icon: this.iconKey,
          name: this.name,
          reminderName: this.reminderType,
          reminderType: this.reminderTypeId,
          of: this.of,
          days: this.days
        },
        success: function(res) {
          // res æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå…¶ä¸­æœ‰ _id å­—æ®µæ ‡è®°åˆšåˆ›å»ºçš„è®°å½•çš„ id
          console.log(res);
          Toast.success('æ·»åŠ æˆåŠŸï¼Œå³å°†è¿”å›é¦–é¡µ');
          setTimeout(() => {
            wx.navigateTo({ url: '/pages/index' });
          }, 2000);
        }
      });
    }
  },
  created() {
    wx.cloud.init();
    const db = wx.cloud.database();
    this.db = db;
  }
});
</script>
<config>
{
    navigationBarTitleText: 'æ–°å¢',
    usingComponents: {
      "van-button": "module:@vant/weapp/dist/button/index",
      "van-image": "module:@vant/weapp/dist/image/index",
      "van-field": "module:@vant/weapp/dist/field/index",
      "van-calendar": "module:@vant/weapp/dist/calendar/index",
      "van-popup": "module:@vant/weapp/dist/popup/index",
      "van-toast": "module:@vant/weapp/dist/toast/index",
      "van-picker": "module:@vant/weapp/dist/picker/index",
      "van-icon": "module:@vant/weapp/dist/icon/index",
      "van-radio":"module:@vant/weapp/dist/radio/index",
      "van-radio-group":"module:@vant/weapp/dist/radio-group/index",
    }
}
</config>
